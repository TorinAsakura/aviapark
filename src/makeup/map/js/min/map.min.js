var Map={iconUrl:"http://api.avia.kknopka.ru/",Style:{color:"#525765",strokeColor:"#525765","stroke-Width":2,weight:2,fillColor:"#484c5b",fillOpacity:1},kinoStyle:{color:"#3A3E4E",strokeColor:"#3A3E4E","stroke-Width":2,weight:2,fillColor:"#3A3E4E",fillOpacity:1},kinoStyle2:{color:"#A7F0DD",strokeColor:"#A7F0DD","stroke-Width":2,weight:2,fillColor:"#414554",fillOpacity:1},kinoStyle3:{color:"#A7F0DD",strokeColor:"#A7F0DD","stroke-Width":2,weight:2,fillColor:"#A7F0DD",fillOpacity:1},staticStyle1:{color:"#3A3E4E",strokeColor:"#3A3E4E","stroke-Width":0,weight:0,fillColor:"#3A3E4E",fillOpacity:1},staticStyle2:{color:"#414554",strokeColor:"#414554","stroke-Width":0,weight:0,fillColor:"#414554",fillOpacity:1},hoverStyle:{color:"#A7F0DD",strokeColor:"#A7F0DD","stroke-Width":2,weight:2,fillColor:"#A7F0DD",fillOpacity:1},LGroup:[],LLevels:[],LStatic:[],LMarkers:[],LPromo:[],Level:[],geojsonFeatureL:[],mapMinZoom:10,mapMaxZoom:13,mapCurZoom:10,mapCurLevel:1,mapCenter:[2.220972689603263,1.0725402832031248],init:function(o){Map.southWest=L.latLng(1.4212104387885494,-.5657958984375),Map.northEast=L.latLng(3.023955250363652,2.581787109375),Map.mapBounds=L.latLngBounds(Map.southWest,Map.northEast);for(var e=1;5>e;e++)Map.LGroup[e]=new L.LayerGroup,Map.LLevels[e]=new L.LayerGroup,Map.LMarkers[e]=new L.LayerGroup,Map.LPromo[e]=new L.LayerGroup,Map.LStatic[e]=new L.LayerGroup,Map.LStatic[e].addTo(Map.LGroup[e]),Map.LMarkers[e].addTo(Map.LGroup[e]),Map.LPromo[e].addTo(Map.LGroup[e]);Map.LKino=new L.LayerGroup,Map.baseLayers={4:Map.LGroup[4],2:Map.LGroup[2],3:Map.LGroup[3],1:Map.LGroup[1]},Map.map=L.map("map",{maxZoom:Map.mapMaxZoom,minZoom:Map.mapMinZoom,layers:[Map.LGroup[1]],tap:!1,zoomControl:!1,inertia:!1,bounceAtZoomLimits:!1}).setView(Map.mapCenter,Map.mapMinZoom),Map.map.fitBounds(Map.map.getBounds()),Map.map.setMaxBounds(Map.map.getBounds()),L.control.layers(Map.baseLayers).addTo(Map.map),L.control.zoom({position:"topright"}).addTo(Map.map),void 0!==o&&Map.loadLayers()},loadLayers:function(){return Map.loadStatic(1),Map.startListeners(),!0},loadLayer:function(o){$.getJSON("/aviapark/build/map/"+o+"-level.json",function(e){Map.geojsonFeatureL[o]=e,Map.Level[o]=L.geoJson(Map.geojsonFeatureL[o],{onEachFeature:function(o,e){e.setStyle(Map.Style),function(o,e){"4003"!=e.magId&&(o.on("mouseover",function(){o.setStyle(Map.hoverStyle)}),o.on("mouseout",function(){o.setStyle(Map.Style)}))}(e,o.properties)}}).addTo(Map.LLevels[o]),Map.LLevels[o].addTo(Map.LGroup[o]),itemsL={},$.getJSON("http://api.avia.kknopka.ru/items/map/"+o,function(e){$.each(e,function(o,e){itemsL[o]=e}),Map.Level[o].eachLayer(function(e){try{tmagId=e.feature.properties.magId,tcenter=[itemsL[tmagId].x,itemsL[tmagId].y],popuphtml="<div class='leaflet-popup-text modal-link' data-toggle='modal' data-target='#link-modal-shop'><div class='leaflet-popup-text-title'>"+itemsL[tmagId].title+"</div><div class='leaflet-popup-text-category'>"+itemsL[tmagId].category_title+"</div></div><div class='leaflet-popup-logo'><img src='"+Map.iconUrl+itemsL[tmagId].logo+"'></img></div>",e.bindPopup(popuphtml),obj={},itemsL[tmagId].actions?(obj=L.marker(tcenter,{icon:Icon}).bindLabel(itemsL[tmagId].title,{noHide:!0,offset:[-40,10]}),PromoIcon=L.Icon.extend({options:{iconSize:[55,55],iconAnchor:[27,55]}}),PIcon=new PromoIcon({iconUrl:Map.iconUrl+itemsL[tmagId].actions[0]}),promo=L.marker(tcenter,{icon:PIcon}),promo.addTo(Map.LPromo[o]),obj.addTo(Map.LMarkers[o]),promo.zoomLevel=0,promo.isPromo=!0):(MarkerIcon=L.Icon.extend({options:{iconSize:[20,20]}}),Icon=new MarkerIcon({iconUrl:Map.iconUrl+itemsL[tmagId].icon}),obj=L.marker(tcenter,{icon:Icon}).bindLabel(itemsL[tmagId].title,{noHide:!0,offset:[-40,10]}),obj.addTo(Map.LMarkers[o])),obj.zoomLevel=itemsL[tmagId].zoom||99}catch(a){}}),1==o&&Map.LMarkers[o].eachLayer(function(o){o.zoomLevel<11?o.showLabel():o._icon.style.display="none"})})}).done(function(){return console.log("load Layer L:"+o),Map.loadStatic(o+1)})},loadStatic:function(o){return o>4?Map.loadKino():($.getJSON("/aviapark/build/map/"+o+"-level-static.json",function(e){Map.geojsonFeatureL[o]=e,l0={type:"FeatureCollection",features:[Map.geojsonFeatureL[o].features[0]]},Map.LStatic[o]=L.geoJson(l0,{onEachFeature:function(o,e){e.setStyle(Map.staticStyle1)}}).addTo(Map.LStatic[o]),Map.geojsonFeatureL[o].features=Map.geojsonFeatureL[o].features.slice(1,Map.geojsonFeatureL[o].features.length),Map.LStatic[o]=L.geoJson(Map.geojsonFeatureL[o],{onEachFeature:function(o,e){e.feature.properties.icon?(Icon=L.icon({iconUrl:Map.iconUrl+"/site/assets/icons/poi-"+e.feature.properties.icon+".svg",iconSize:[32,32],iconAnchor:[16,16]}),e.setIcon(Icon)):e.setStyle(Map.staticStyle2)}}).addTo(Map.LStatic[o])}).done(function(){console.log("load Static L:"+o),Map.loadLayer(o)}),void 0)},loadKino:function(){$.getJSON("/aviapark/build/map/kino.json",function(o){Map.LKino=L.geoJson(o,{onEachFeature:function(o,e){properties=o.properties,tcenter=[properties.x,properties.y],e.setStyle(Map.kinoStyle),popuphtml="<div class='modal-link' data-toggle='modal' data-target='#link-modal-cinema'>"+properties.desc+"</div>",e.bindPopup(popuphtml),MarkerIcon=L.Icon.extend({options:{iconSize:[20,20]}}),Icon=new MarkerIcon({iconUrl:Map.iconUrl+"site/assets/icons/karo-"+properties.icon+".svg"}),obj=L.marker(tcenter,{icon:Icon}),console.log(obj),console.log(e),obj.addTo(Map.LMarkers[4]),obj.zoomLevel=11,function(o){o.on("mouseover",function(){o._popup._isOpen||(console.log(o),o.setStyle(Map.kinoStyle2))}),o.on("mouseout",function(){o._popup._isOpen||(console.log(o),o.setStyle(Map.kinoStyle))}),o.on("popupopen",function(){o.setStyle(Map.kinoStyle3),console.log("Wtf?")}),o.on("popupclose",function(){o.setStyle(Map.kinoStyle)})}(e)}}).addTo(Map.LLevels[4])}).done(function(){return console.log("Load kino"),!0})},startListeners:function(){Map.map.on("zoomend",function(o){newZoom=o.target._zoom,newZoom>Map.mapCurZoom?console.log("zoomed"):console.log("unzoomed"),Map.LMarkers[Map.mapCurLevel].eachLayer(function(o){o.zoomLevel>newZoom?(o.hideLabel(),o._icon.style.display="none"):(o.showLabel(),o._icon.style.display="")}),Map.mapCurZoom=newZoom}),Map.map.on("baselayerchange",function(o){Map.LMarkers[o.name].eachLayer(function(o){o.zoomLevel>Map.mapCurZoom?(o.hideLabel(),o._icon.style.display="none"):(o.showLabel(),o._icon.style.display="")}),Map.mapCurLevel=o.name})},hidePromo:function(){return Map.LMarkers[Map.mapCurLevel].eachLayer(function(o){o.isPromo&&(o._icon.style.display="none")}),!0},showPromo:function(){return Map.LMarkers[Map.mapCurLevel].eachLayer(function(o){o.isPromo&&(o._icon.style.display="")}),!0},loadPromo:function(o){return $.each(o,function(o){tcenter=[o.x,o.y],PromoIcon=L.Icon.extend({options:{iconSize:[55,55],iconAnchor:[27,55]}}),PIcon=new PromoIcon({iconUrl:Map.iconUrl+o.icon}),promo=L.marker(tcenter,{icon:PIcon}),promo.addTo(Map.LPromo[Map.mapCurLevel]),promo.zoomLevel=0,promo.isPromo=!0}),Map.LPromo[Map.mapCurLevel].addTo(Map.LGroup[Map.mapCurLevel]),!0},clearPromo:function(){return Map.LPromo[Map.mapCurLevel].clearLayers(),console.log(Map.LPromo[Map.mapCurLevel]),!0},setFocus:function(o,e,a){Map.LLevels[Map.mapCurLevel].eachLayer(function(t){t.eachLayer(function(t){t.feature.properties.magId==o&&(console.log(t.feature.properties.magId),console.log(t.feature.geometry.coordinates[0]),Map.map.setView([e,a],12,{animate:!0}))})})},clearFocus:function(){Map.map.setView(Map.mapCenter,Map.mapMinZoom,{animate:!0})},end:function(){Map.LLevels[Map.mapCurLevel].eachLayer(function(o){console.log(o)})}};